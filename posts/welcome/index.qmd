---
title: "Monitoramento de frota de √¥nibus"
author: "Anielly Miranda"
date: "2025-11-20"
categories: [code, monitoramento dos √¥nibus]
jupyter: python3
image: "onibus.png"
---

Mapeando a mobilidade urbana! 
Nesta atividade, constru√≠ um mapa interativo com as paradas de uma linha de √¥nibus e a posi√ß√£o em tempo real dos ve√≠culos. 


```{python}
import requests
import folium
import os
from dotenv import load_dotenv

load_dotenv()
TOKEN = os.getenv("TOKEN_SPTRANS")
URL_BASE = "https://api.olhovivo.sptrans.com.br/v2.1"

if not TOKEN:
    raise ValueError("‚ùå Token SPTrans n√£o encontrado.")

# Cria uma sess√£o persistente
sess = requests.Session()

# 1Ô∏è‚É£ Autentica√ß√£o
login_url = f"{URL_BASE}/Login/Autenticar?token={TOKEN}"
auth = sess.post(login_url)
if auth.status_code != 200 or auth.json() is not True:
    raise Exception(f"‚ùå Falha na autentica√ß√£o ({auth.status_code}): {auth.text}")
print("‚úÖ Autentica√ß√£o bem-sucedida!")

# 2Ô∏è‚É£ Buscar a linha
numero_linha = "875A-10"
busca_linha_url = f"{URL_BASE}/Linha/Buscar?termosBusca={numero_linha}"
resp_linha = sess.get(busca_linha_url)
if resp_linha.status_code != 200 or not resp_linha.json():
    raise Exception(f"‚ùå Linha n√£o encontrada. Status: {resp_linha.status_code}")

linha = resp_linha.json()[0]
codigo_linha = linha["cl"]
nome_linha = f"{linha['lt']} - {linha['tp']}"
print(f"üöç Linha encontrada: {nome_linha} (C√≥digo {codigo_linha})")

# 3Ô∏è‚É£ Buscar paradas
paradas_url = f"{URL_BASE}/Parada/BuscarParadasPorLinha?codigoLinha={codigo_linha}"
resp_paradas = sess.get(paradas_url)
paradas = resp_paradas.json()

print(f"üìç {len(paradas)} paradas encontradas.")
lats = [p["py"] for p in paradas]
lons = [p["px"] for p in paradas]
centro = (sum(lats)/len(lats), sum(lons)/len(lons))
mapa = folium.Map(location=centro, zoom_start=12)

for p in paradas:
    folium.Marker(
        location=(p["py"], p["px"]),
        popup=p["np"],
        icon=folium.Icon(color="blue")
    ).add_to(mapa)

# 4Ô∏è‚É£ Posi√ß√µes em tempo real
posicao_url = f"{URL_BASE}/Posicao/Linha?codigoLinha={codigo_linha}"
resp_posicao = sess.get(posicao_url)
dados = resp_posicao.json()
veiculos = dados.get("vs", [])
print(f"üö¶ {len(veiculos)} ve√≠culos em tempo real.")

for v in veiculos:
    folium.Marker(
        location=(v["py"], v["px"]),
        popup=f"Ve√≠culo: {v['p']}",
        icon=folium.Icon(color="red")
    ).add_to(mapa)

mapa.save("mapa_875A10.html")
print("üó∫Ô∏è Mapa salvo como mapa_875A10.html")

```

